<div class="space-y-3 sm:space-y-4">
  {% for a in announcements %}
    <article class="bg-white rounded-xl shadow-sm p-3 sm:p-5 border border-neutral-200" data-announcement-id="{{ a.id }}">
      <header class="flex items-start justify-between gap-3">
        <div class="flex flex-wrap items-center gap-2">
          {% if a.priority == 'URGENT' %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-[11px] bg-red-100 text-red-700 border border-red-200">
              <i class="fas fa-exclamation-triangle"></i> Urgent
            </span>
          {% elif a.priority == 'IMPORTANT' %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-[11px] bg-yellow-100 text-yellow-800 border border-yellow-200">
              <i class="fas fa-star"></i> Important
            </span>
          {% else %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-[11px] bg-blue-100 text-blue-800 border border-blue-200">
              <i class="fas fa-info-circle"></i> Info
            </span>
          {% endif %}

          {% if a.pinned %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-[11px] bg-purple-100 text-purple-800 border border-purple-200">
              <i class="fas fa-thumbtack"></i> Pinned
            </span>
          {% endif %}

          {% if not a.is_read %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-[11px] bg-emerald-100 text-emerald-800 border border-emerald-200">
              <i class="fas fa-sparkles"></i> New
            </span>
          {% endif %}

          <!-- Category badge -->
          {% if a.category == 'ATTENDANCE' %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs bg-red-100 text-red-700 border border-red-200">
              <i class="fas fa-user-times"></i> Attendance
            </span>
          {% elif a.category == 'EVENT' %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs bg-green-100 text-green-700 border border-green-200">
              <i class="fas fa-calendar-alt"></i> Event
            </span>
          {% elif a.category == 'ACADEMIC' %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs bg-blue-100 text-blue-700 border border-blue-200">
              <i class="fas fa-book"></i> Academic
            </span>
          {% else %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs bg-neutral-100 text-neutral-700 border border-neutral-200">
              <i class="fas fa-bullhorn"></i> General
            </span>
          {% endif %}

          <!-- Delivery badges (wrap) -->
          <div class="flex flex-wrap items-center gap-1 ml-1 mt-1 sm:mt-0">
            {% for ch in a.delivery_channels %}
              {% if ch == 'DASH' %}
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-[10px] bg-neutral-100 text-neutral-700 border border-neutral-200">
                  <i class="fas fa-broadcast-tower"></i> In-app
                </span>
              {% elif ch == 'EMAIL' %}
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-[10px] bg-emerald-100 text-emerald-800 border border-emerald-200">
                  <i class="fas fa-envelope"></i> Email
                </span>
              {% elif ch == 'SMS' %}
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-[10px] bg-indigo-100 text-indigo-800 border border-indigo-200">
                  <i class="fas fa-sms"></i> SMS
                </span>
              {% elif ch == 'PUSH' %}
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-[10px] bg-orange-100 text-orange-800 border border-orange-200">
                  <i class="fas fa-bell"></i> Push
                </span>
              {% endif %}
            {% endfor %}
          </div>
        </div>

        <!-- Right info block: prevent shrinking on small screens -->
        <div class="flex-shrink-0 text-right text-xs sm:text-sm text-neutral-500 min-w-[120px] sm:min-w-0">
          <div>{{ a.publish_at|date:"M d, Y h:i A" }}</div>
          {% if a.expires_at %}
            <div class="mt-1">Valid until {{ a.expires_at|date:"M d" }}</div>
          {% endif %}
          <div class="mt-1 text-neutral-600">Posted by {{ a.created_by.get_full_name|default:a.created_by.username }}</div>
        </div>
      </header>

      <h2 class="mt-2 sm:mt-3 text-base sm:text-lg font-semibold text-neutral-900">{{ a.title }}</h2>
      <p class="mt-1 sm:mt-2 text-[13px] sm:text-sm text-neutral-700 break-words">{{ a.message|linebreaksbr }}</p>

      <!-- Links -->
      {% if a.links %}
        <div class="mt-3 sm:mt-4 flex flex-wrap gap-2">
          {% for link in a.links %}
            <a href="{{ link.url }}" target="_blank" rel="noopener" class="inline-flex items-center gap-2 px-3 py-2 text-[13px] sm:text-sm rounded-lg border border-neutral-200 hover:bg-neutral-50 w-full sm:w-auto">
              <i class="fas fa-link text-neutral-500"></i>
              {{ link.label|default:link.url }}
            </a>
          {% endfor %}
        </div>
      {% endif %}

      <!-- Videos -->
      {% if a.videos %}
        <div class="mt-3 sm:mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
          {% for v in a.videos %}
            {% if "youtube.com" in v or "youtu.be" in v %}
              {% with v|cut:'https://youtu.be/'|cut:'https://www.youtube.com/watch?v=' as yid %}
                <iframe class="aspect-video w-full rounded-lg border border-neutral-200" src="https://www.youtube.com/embed/{{ yid }}" frameborder="0" allowfullscreen referrerpolicy="strict-origin-when-cross-origin"></iframe>
              {% endwith %}
            {% elif "vimeo.com" in v %}
              {% with v|cut:'https://vimeo.com/' as vid %}
                <iframe class="aspect-video w-full rounded-lg border border-neutral-200" src="https://player.vimeo.com/video/{{ vid }}" frameborder="0" allowfullscreen referrerpolicy="strict-origin-when-cross-origin"></iframe>
              {% endwith %}
            {% else %}
              <div class="aspect-video bg-neutral-100 rounded-lg border border-neutral-200 flex items-center justify-center text-neutral-500 text-[12px] sm:text-sm">
                <i class="fas fa-video mr-2"></i> Unsupported video host
              </div>
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}

      <!-- Attachments -->
      {% if a.attachments.all %}
        <div class="mt-3 sm:mt-4 flex flex-wrap gap-2">
          {% for att in a.attachments.all %}
            <a href="{{ att.file.url }}" class="inline-flex items-center gap-2 px-3 py-2 text-[13px] sm:text-sm rounded-lg border border-neutral-200 hover:bg-neutral-50 w-full sm:w-auto">
              <i class="fas fa-paperclip text-neutral-500"></i>
              {{ att.label|default:att.file.name }}
            </a>
          {% endfor %}
        </div>
      {% endif %}

      <!-- Footer -->
      <footer class="mt-4 sm:mt-6 flex flex-wrap items-center justify-between gap-3">
        <div class="flex flex-wrap items-center gap-2 text-[12px] sm:text-sm text-neutral-600">
          <!-- Audience badge -->
          <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-neutral-100 text-neutral-700 border border-neutral-200">
            <i class="fas fa-users"></i>
            {% if a.classes.all or a.division.all %}
              Custom audience
            {% else %}
              {% if a.target == 'ALL' %}All Users{% elif a.target == 'TEACHERS' %}Teachers{% elif a.target == 'PARENTS' %}Parents{% else %}Targeted{% endif %}
            {% endif %}
          </span>

          <!-- Classes pills -->
          {% if a.classes.all %}
            <span class="flex flex-wrap gap-1">
              {% for c in a.classes.all %}
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-700 border border-indigo-200">{{ c.name }}</span>
              {% endfor %}
            </span>
          {% endif %}

          <!-- Divisions pills -->
          {% if a.division.all %}
            <span class="flex flex-wrap gap-1">
              {% for d in a.division.all %}
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700 border border-emerald-200">{{ d.name }}</span>
              {% endfor %}
            </span>
          {% endif %}
        </div>

          <!-- Reaction breakdown (annotated counts) -->
    <!-- Like -->
   <div class="flex items-center justify-between mt-3 gap-2 pt-2">
  <div class="flex items-center gap-3 text-[13px] text-neutral-600">
    <button class="react-btn flex items-center gap-1 px-3 py-1 rounded-full 
                   bg-gradient-to-r from-neutral-50 to-neutral-100 border border-neutral-200 
                   hover:from-neutral-100 hover:to-neutral-200 transition"
            data-reaction="LIKE">
      <i class="fas fa-thumbs-up text-sky-500"></i>
      <span class="reaction-count" data-reaction="LIKE">{{ a.likes_count }}</span>
    </button>

    <button class="react-btn flex items-center gap-1 px-3 py-1 rounded-full 
                   bg-gradient-to-r from-neutral-50 to-neutral-100 border border-neutral-200 
                   hover:from-neutral-100 hover:to-neutral-200 transition"
            data-reaction="LOVE">
      <i class="fas fa-heart text-rose-500"></i>
      <span class="reaction-count" data-reaction="LOVE">{{ a.loves_count }}</span>
    </button>

    <button class="react-btn flex items-center gap-1 px-3 py-1 rounded-full 
                   bg-gradient-to-r from-neutral-50 to-neutral-100 border border-neutral-200 
                   hover:from-neutral-100 hover:to-neutral-200 transition"
            data-reaction="ACK">
      <i class="fas fa-check-circle text-emerald-500"></i>
      <span class="reaction-count" data-reaction="ACK">{{ a.acks_count }}</span>
    </button>
  </div>

  <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg border border-neutral-200 
               text-[12px] sm:text-sm text-neutral-600">
    <i class="far fa-eye"></i> {{ a.reads_count }} read
  </span>
</div>


      </footer>
      <!-- Edit/Delete actions (permission check) -->
{% if request.user.is_super_admin or request.user == a.created_by or request.user.role == 'SCHOOL_ADMIN' %}
  <div class="flex mt-4 items-end justify-end gap-2">
    <a href="{% url 'notifications:announcement_edit' a.pk %}" 
       class="flex items-center justify-center w-8 h-8 rounded-full border border-neutral-200 
              hover:bg-neutral-50 transition" 
       title="Edit">
      <i class="far fa-edit text-neutral-600"></i>
    </a>

    <a href="{% url 'notifications:announcement_delete' a.pk %}" 
       class="flex items-center justify-center w-8 h-8 rounded-full border border-neutral-200 
              hover:bg-red-50 transition text-red-600" 
       title="Delete">
      <i class="far fa-trash-alt"></i>
    </a>
  </div>
{% endif %}

    </article>
  {% empty %}
    <div class="bg-white rounded-xl shadow-sm p-6 sm:p-8 text-center text-neutral-600">
      <i class="far fa-bell-slash text-2xl sm:text-3xl mb-2"></i>
      No announcements yet.
    </div>
  {% endfor %}
</div>
