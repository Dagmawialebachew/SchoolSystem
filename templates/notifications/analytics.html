{% extends "base.html" %}
{% block title %}Announcement analytics{% endblock %}

{% block content %}
<div class="max-w-full sm:max-w-6xl mx-auto px-3 sm:px-6 py-4 sm:py-6 space-y-4 sm:space-y-6">

  <!-- Top bar -->
  <div class="flex flex-wrap items-center justify-between">
    <div class="flex items-center gap-3">
      <a href="{% url 'notifications:list' %}"
         class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-neutral-100 hover:bg-neutral-200 text-sm text-neutral-700">
        <i class="fas fa-arrow-left"></i>
        <span class="hidden sm:inline">Back</span>
      </a>
      <h1 class="text-xl sm:text-2xl font-bold text-neutral-900 flex items-center gap-2">
        <i class="fas fa-chart-pie text-primary-600"></i>
        Analytics
      </h1>
    </div>

    <!-- Controls: range + category scope -->
    <div class="flex items-center gap-2">
<select id="range" class="w-full sm:w-auto border rounded-lg px-3 py-2 text-sm">
        <option value="7d" {% if range == '7d' %}selected{% endif %}>7 days</option>
        <option value="30d" {% if range == '30d' %}selected{% endif %}>30 days</option>
        <option value="90d" {% if range == '90d' %}selected{% endif %}>90 days</option>
        <option value="all" {% if range == 'all' %}selected{% endif %}>All time</option>
      </select>

      <select id="scopeCategory" class="w-full sm:w-auto border rounded-lg px-3 py-2 text-sm">
        <option value="" {% if not scope_category %}selected{% endif %}>All categories</option>
        <option value="GENERAL" {% if scope_category == 'GENERAL' %}selected{% endif %}>General</option>
        <option value="ATTENDANCE" {% if scope_category == 'ATTENDANCE' %}selected{% endif %}>Attendance</option>
        <option value="EVENT" {% if scope_category == 'EVENT' %}selected{% endif %}>Event</option>
        <option value="ACADEMIC" {% if scope_category == 'ACADEMIC' %}selected{% endif %}>Academic</option>
      </select>
    </div>
  </div>

  <!-- KPI cards -->
  <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3 sm:gap-4">
    <div class="bg-white p-4 rounded-xl shadow-sm">
      <div class="text-xs text-neutral-500">Total</div>
<div class="mt-1 text-xl sm:text-2xl font-bold text-neutral-900">{{ stats.total }}</div>
    </div>
    <div class="bg-white p-4 rounded-xl shadow-sm">
      <div class="text-xs text-neutral-500">Pinned</div>
      <div class="mt-1 text-2xl font-bold text-purple-600">{{ stats.pinned }}</div>
    </div>
    <div class="bg-white p-4 rounded-xl shadow-sm">
      <div class="text-xs text-neutral-500">Urgent</div>
      <div class="mt-1 text-2xl font-bold text-red-600">{{ stats.urgent }}</div>
    </div>
    <div class="bg-white p-4 rounded-xl shadow-sm">
      <div class="text-xs text-neutral-500">Reads</div>
      <div class="mt-1 text-2xl font-bold text-blue-600">{{ stats.reads }}</div>
    </div>
    <div class="bg-white p-4 rounded-xl shadow-sm">
      <div class="text-xs text-neutral-500">Reactions</div>
      <div class="mt-1 text-2xl font-bold text-emerald-600">{{ stats.reactions }}</div>
    </div>
  </div>

  <!-- Charts -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
    <div class="bg-white p-5 sm:p-6 rounded-xl shadow-sm">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-base sm:text-lg font-semibold">By category</h2>
        <div class="flex gap-1">
          {% for c in categories %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs
                         {% if c.category == 'ATTENDANCE' %}bg-red-100 text-red-700 border border-red-200
                         {% elif c.category == 'EVENT' %}bg-green-100 text-green-700 border border-green-200
                         {% elif c.category == 'ACADEMIC' %}bg-blue-100 text-blue-700 border border-blue-200
                         {% else %}bg-neutral-100 text-neutral-700 border border-neutral-200{% endif %}">
              {{ c.category }} · {{ c.count }}
            </span>
          {% endfor %}
        </div>
      </div>
      <canvas id="categoryChart" class="w-full" height="200"></canvas>
    </div>

    <div class="bg-white p-5 sm:p-6 rounded-xl shadow-sm">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-base sm:text-lg font-semibold">By priority</h2>
        <div class="flex gap-1">
          {% for p in priorities %}
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs
                         {% if p.priority == 'URGENT' %}bg-red-100 text-red-700 border border-red-200
                         {% elif p.priority == 'IMPORTANT' %}bg-yellow-100 text-yellow-700 border border-yellow-200
                         {% else %}bg-blue-100 text-blue-700 border border-blue-200{% endif %}">
              {{ p.priority }} · {{ p.count }}
            </span>
          {% endfor %}
        </div>
      </div>
      <canvas id="priorityChart" height="100"></canvas>
    </div>
  </div>

  <!-- Trend -->
  <div class="bg-white p-5 sm:p-6 rounded-xl shadow-sm">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-base sm:text-lg font-semibold">Engagement over time</h2>
      <span class="text-xs text-neutral-500">
        Range: {% if range == 'all' %}All time{% else %}Last {{ range|slice:":-1" }} days{% endif %}
        {% if scope_category %} · {{ scope_category|title }}{% endif %}
      </span>
    </div>
    <canvas id="trendChart" height="120"></canvas>
  </div>

  <!-- Recent -->
  <div class="bg-white p-5 sm:p-6 rounded-xl shadow-sm">
    <h2 class="text-base sm:text-lg font-semibold mb-3">Recent announcements</h2>
    <ul class="divide-y divide-neutral-200">
      {% for a in recent %}
<li class="py-3 flex flex-wrap max-md:grid max-md:grid-cols-2 items-center justify-between gap-3">
          <div class="min-w-0">
            <div class="font-medium truncate">{{ a.title }}</div>
            <div class="text-xs text-neutral-500">{{ a.publish_at|date:"M d, Y h:i A" }}</div>
          </div>
          <div class="flex-shrink-0 flex items-center gap-3 text-sm text-neutral-600">
            <span class="inline-flex items-center gap-1"><i class="far fa-eye"></i> {{ a.reads.count }}</span>
            <span class="inline-flex items-center gap-1"><i class="far fa-thumbs-up"></i> {{ a.reactions.count }}</span>
          </div>
        </li>
      {% empty %}
        <li class="py-3 text-neutral-500">No announcements yet.</li>
      {% endfor %}
    </ul>
  </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Controls: apply range/category via query params
  const rangeSel = document.getElementById("range");
  const catSel = document.getElementById("scopeCategory");
  function applyFilters() {
    const params = new URLSearchParams(window.location.search);
    const setOrDel = (k,v) => v ? params.set(k,v) : params.delete(k);
    setOrDel("range", rangeSel.value);
    setOrDel("scope_category", catSel.value);
    window.location.replace(`${window.location.pathname}?${params.toString()}`);
  }
  rangeSel.addEventListener("change", applyFilters);
  catSel.addEventListener("change", applyFilters);

  // Palette
  const colors = {
    blue: '#3b82f6',
    red: '#ef4444',
    green: '#10b981',
    yellow: '#f59e0b',
    purple: '#8b5cf6',
    gray: '#64748b'
  };

  // Category chart (donut)
  const categoryCtx = document.getElementById('categoryChart').getContext('2d');
  new Chart(categoryCtx, {
    type: 'doughnut',
    data: {
      labels: [{% for c in categories %}'{{ c.category }}'{% if not forloop.last %},{% endif %}{% endfor %}],
      datasets: [{
        data: [{% for c in categories %}{{ c.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
        backgroundColor: [colors.blue, colors.red, colors.green, colors.yellow, colors.purple],
        borderWidth: 0
      }]
    },
    options: {
      responsive: false,
      plugins: {
        legend: { position: 'bottom', labels: { boxWidth: 10 } },
        tooltip: { mode: 'index', intersect: false }
      },
      cutout: '60%'
    }
  });

  // Priority chart (rounded bars)
  const priorityCtx = document.getElementById('priorityChart').getContext('2d');
  new Chart(priorityCtx, {
    type: 'bar',
    data: {
      labels: [{% for p in priorities %}'{{ p.priority }}'{% if not forloop.last %},{% endif %}{% endfor %}],
      datasets: [{
        label: 'Count',
        data: [{% for p in priorities %}{{ p.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
        backgroundColor: colors.blue,
        borderRadius: 6,
        maxBarThickness: 44
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: { mode: 'index', intersect: false }
      },
      scales: {
        y: { beginAtZero: true, ticks: { stepSize: 1 } },
        x: { grid: { display: false } }
      }
    }
  });

  // Trend chart (smooth area lines)
  const trendCtx = document.getElementById('trendChart').getContext('2d');
  const trendLabels = [{% for t in trend %}'{{ t.day|date:"M d" }}'{% if not forloop.last %},{% endif %}{% endfor %}];
  const trendReads = [{% for t in trend %}{{ t.reads }}{% if not forloop.last %},{% endif %}{% endfor %}];
  const trendReactions = [{% for t in trend %}{{ t.reactions }}{% if not forloop.last %},{% endif %}{% endfor %}];

  new Chart(trendCtx, {
    type: 'line',
    data: {
      labels: trendLabels,
      datasets: [
        {
          label: 'Reads',
          data: trendReads,
          borderColor: colors.blue,
          backgroundColor: 'rgba(59,130,246,0.15)',
          tension: 0.35,
          fill: true
        },
        {
          label: 'Reactions',
          data: trendReactions,
          borderColor: colors.green,
          backgroundColor: 'rgba(16,185,129,0.15)',
          tension: 0.35,
          fill: true
        }
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      plugins: { legend: { position: 'bottom' } },
      scales: {
        y: { beginAtZero: true, ticks: { stepSize: 1 } },
        x: { grid: { display: false } }
      }
    }
  });
});
</script>
{% endblock %}
