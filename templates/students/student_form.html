{% extends 'base.html' %}

{% block title %}{% if object %}Edit{% else %}Add{% endif %} Student - SchoolSystem{% endblock %}
{% load widget_tweaks %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-neutral-900 flex items-center gap-2">
            <i class="fas {% if object %}fa-user-edit{% else %}fa-user-plus{% endif %} text-primary-600"></i>
            {% if object %}Edit Student{% else %}Add Student{% endif %}
        </h1>
        <a href="{% url 'students:list' %}" class="text-sm font-medium text-neutral-600 hover:text-primary-600 transition">
            <i class="fas fa-arrow-left mr-1"></i> Back to Students
        </a>
    </div>

    <!-- Card -->
    <div class="bg-white shadow-md rounded-2xl p-8 border border-neutral-200">
        <form method="post" class="space-y-6">
            {% csrf_token %}

            <!-- Collapsible: Student Info -->
            <div class="border border-neutral-200 rounded-xl overflow-hidden">
                <button type="button" class="collapsible w-full flex justify-between items-center px-4 py-3 bg-neutral-100 hover:bg-neutral-200">
                    <span class="font-semibold text-neutral-800"><i class="fas fa-user mr-2 text-primary-600"></i> Student Info</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="collapsible-content p-4 space-y-4 ">
                    <div>
                        <label class="block text-sm font-semibold text-neutral-700 mb-2">Full Name *</label>
                        {{ form.full_name|add_class:"w-full rounded-lg border-neutral-300 focus:ring-2 focus:ring-primary-500 shadow-sm" }}
                        {% if form.full_name.errors %}
                            <p class="text-xs text-danger-500 mt-1">{{ form.full_name.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-neutral-700 mb-2">Date of Birth</label>
                            {{ form.date_of_birth|add_class:"w-full rounded-lg border-neutral-300 focus:ring-2 focus:ring-primary-500 shadow-sm" }}
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-neutral-700 mb-2">Division *</label>
                            {{ form.division|add_class:"w-full rounded-lg border-neutral-300 focus:ring-2 focus:ring-primary-500 shadow-sm" }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Collapsible: Parent Info -->
            <div class="border border-neutral-200 rounded-xl overflow-hidden">
                <button type="button" class="collapsible w-full flex justify-between items-center px-4 py-3 bg-neutral-100 hover:bg-neutral-200">
                    <span class="font-semibold text-neutral-800"><i class="fas fa-user-friends mr-2 text-primary-600"></i> Parent Info</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="collapsible-content p-4 grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                    <div>
                        <label class="block text-sm font-semibold text-neutral-700 mb-2">Parent Name *</label>
                        {{ form.parent_name|add_class:"w-full rounded-lg border-neutral-300 focus:ring-2 focus:ring-primary-500 shadow-sm" }}
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-neutral-700 mb-2">Parent Phone *</label>
                        {{ form.parent_phone|add_class:"w-full rounded-lg border-neutral-300 focus:ring-2 focus:ring-primary-500 shadow-sm" }}
                    </div>
                </div>
            </div>

            <!-- Collapsible: Fee Structure -->
            <div class="border border-neutral-200 rounded-xl overflow-hidden">
                <button type="button" class="collapsible w-full flex justify-between items-center px-4 py-3 bg-neutral-100 hover:bg-neutral-200">
                    <span class="font-semibold text-neutral-800"><i class="fas fa-money-bill-wave mr-2 text-primary-600"></i> Fee Structure</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="collapsible-content p-4 space-y-4 hidden">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        {% for fee in fee_structures %}
                        <label class="flex items-center gap-3 p-4 rounded-xl border border-neutral-300 bg-white hover:bg-primary-50 cursor-pointer
                          {% if fee.id in selected_fees %}
        border-primary-500 bg-primary-50
    {% else %}
        border-neutral-300 hover:bg-primary-50
    {% endif %}">
                            <input type="checkbox" name="fee_structures" value="{{ fee.id }}" 
                                class="fee-checkbox w-5 h-5 accent-primary-600"
                                {% if fee.id in selected_fees %}checked{% endif %}>
                            <span class="font-medium text-neutral-800">{{ fee.name }} - {{ fee.amount }} {{ fee.currency }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    <div class="font-bold text-neutral-800">Total: <span id="total-fees">0</span></div>
                </div>
            </div>

            <!-- Collapsible: Billing Setup -->
            <div class="border border-neutral-200 rounded-xl overflow-hidden">
                <button type="button" class="collapsible w-full flex justify-between items-center px-4 py-3 bg-neutral-100 hover:bg-neutral-200">
                    <span class="font-semibold text-neutral-800"><i class="fas fa-credit-card mr-2 text-primary-600"></i> Billing Setup</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="collapsible-content p-4 grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                    <div>
                        <label class="block text-sm font-semibold text-neutral-700 mb-2">Billing Cycle *</label>
                        {{ form.billing_cycle|add_class:"w-full rounded-lg border-neutral-300 focus:ring-2 focus:ring-primary-500 shadow-sm" }}
                    </div>
                    <div id="custom-months-wrapper" class="hidden">
                        <label class="block text-sm font-semibold text-neutral-700 mb-2">Custom Months *</label>
                        {{ form.custom_months|add_class:"w-full rounded-lg border-neutral-300 focus:ring-2 focus:ring-primary-500 shadow-sm" }}
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-neutral-700 mb-2">Payment Status *</label>
                        {{ form.payment_status|add_class:"w-full rounded-lg border-neutral-300 focus:ring-2 focus:ring-primary-500 shadow-sm" }}
                    </div>
                </div>
            </div>

            <!-- Collapsible: Late Enrollment Setup -->
            <div class="border border-neutral-200 rounded-xl overflow-hidden">
                <button type="button" class="collapsible w-full flex justify-between items-center px-4 py-3 bg-neutral-100 hover:bg-neutral-200">
                    <span class="font-semibold text-neutral-800"><i class="fas fa-hourglass-half mr-2 text-primary-600"></i> Late Enrollment Setup</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="collapsible-content p-4 grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                    <div>
                        <label class="block text-sm font-semibold text-neutral-700 mb-2">Start Billing Month</label>
                        {{ form.starting_billing_month|add_class:"w-full rounded-lg border-neutral-300 focus:ring-2 focus:ring-primary-500 shadow-sm" }}
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-neutral-700 mb-2">Opening Balance</label>
                        {{ form.opening_balance|add_class:"w-full rounded-lg border-neutral-300 focus:ring-2 focus:ring-primary-500 shadow-sm" }}
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="flex justify-end space-x-3 pt-6 border-t">
                <a href="{% url 'students:list' %}"
                   class="px-4 py-2 rounded-lg text-sm font-medium bg-neutral-100 text-neutral-700 hover:bg-neutral-200 transition">
                    <i class="fas fa-times mr-1"></i> Cancel
                </a>
                <button type="submit"
                        class="px-5 py-2 rounded-lg text-sm font-semibold bg-primary-600 text-white shadow-md hover:bg-primary-700 transition">
                    <i class="fas fa-save mr-1"></i>
                    {% if object %}Update{% else %}Create{% endif %} Student
                </button>
            </div>
        </form>
    </div>
</div>

<script>

document.addEventListener("DOMContentLoaded", () => {
  // Collapsible toggle
  document.querySelectorAll(".collapsible").forEach((btn) => {
    btn.addEventListener("click", () => {
      const content = btn.nextElementSibling;
      content.classList.toggle("hidden");
      const chevron = btn.querySelector(".chevron");
      chevron.textContent = content.classList.contains("hidden") ? "▼" : "▲";
    });
  });

  // Fee total calculation
  const feeCheckboxes = document.querySelectorAll(".fee-checkbox");
  const totalFeeDisplay = document.getElementById("total-fee");
  function updateTotal() {
    let total = 0;
    feeCheckboxes.forEach((cb) => {
      if (cb.checked) total += parseFloat(cb.dataset.amount);
    });
    totalFeeDisplay.textContent = total.toFixed(2);
  }
  feeCheckboxes.forEach((cb) => cb.addEventListener("change", updateTotal));
  updateTotal();

  // Show custom months field
  const billingCycle = document.getElementById("id_billing_cycle");
  const customField = document.getElementById("custom-months-field");
  function toggleCustom() {
    customField.classList.toggle("hidden", billingCycle.value !== "CUSTOM");
  }
  billingCycle.addEventListener("change", toggleCustom);
  toggleCustom();

  // Auto next payment date
  const startMonth = document.getElementById("start-month");
  const nextDate = document.getElementById("next-payment-date");
  billingCycle.addEventListener("change", calcNextDate);
  startMonth.addEventListener("input", calcNextDate);

  function calcNextDate() {
    if (!startMonth.value) {
      nextDate.value = "";
      return;
    }
    const date = new Date(startMonth.value + "-01");
    if (billingCycle.value === "MONTHLY") date.setMonth(date.getMonth() + 1);
    if (billingCycle.value === "TERMLY") date.setMonth(date.getMonth() + 4);
    nextDate.value = date.toLocaleDateString();
  }
});
</script>

<script>


    document.addEventListener("DOMContentLoaded", () => {
  // ========= COLLAPSIBLE SECTIONS =========
  // ========= TOTAL FEES CALCULATION =========
  const feeCheckboxes = document.querySelectorAll(".fee-checkbox");
  const totalFeesEl = document.getElementById("total-fees");
  if (feeCheckboxes.length && totalFeesEl) {
    const updateTotal = () => {
      let total = 0;
      feeCheckboxes.forEach((cb) => {
        if (cb.checked) {
          const text = cb.parentElement.innerText;
          const match = text.match(/(\d+(\.\d+)?)/);
          if (match) total += parseFloat(match[1]);
        }
      });
      totalFeesEl.textContent = `${total.toFixed(2)} birr`;
    };

    feeCheckboxes.forEach((cb) => cb.addEventListener("change", updateTotal));
    updateTotal();
  }

  // ========= CUSTOM MONTHS FIELD TOGGLE =========
  const billingCycleSelect = document.querySelector("#id_billing_cycle");
  const customMonthsWrapper = document.getElementById("custom-months-wrapper");
  if (billingCycleSelect && customMonthsWrapper) {
    const toggleCustomMonths = () => {
      if (billingCycleSelect.value === "CUSTOM") {
        customMonthsWrapper.classList.remove("hidden");
      } else {
        customMonthsWrapper.classList.add("hidden");
      }
    };
    billingCycleSelect.addEventListener("change", toggleCustomMonths);
    toggleCustomMonths();
  }

  // ========= AUTO NEXT PAYMENT DATE (Future Extension) =========
  const startMonthInput = document.querySelector("#id_start_billing_month");
  const cycleInput = document.querySelector("#id_billing_cycle");
  const nextPaymentPreview = document.getElementById("next-payment-preview");

  if (startMonthInput && cycleInput && nextPaymentPreview) {
    const calculateNextPayment = () => {
      const startDate = new Date(startMonthInput.value);
      if (!isNaN(startDate.getTime())) {
        let monthsToAdd = 1;
        if (cycleInput.value === "QUARTERLY") monthsToAdd = 3;
        if (cycleInput.value === "SEMI_ANNUAL") monthsToAdd = 6;
        if (cycleInput.value === "ANNUAL") monthsToAdd = 12;

        const nextDate = new Date(startDate);
        nextDate.setMonth(nextDate.getMonth() + monthsToAdd);

        nextPaymentPreview.textContent = nextDate.toISOString().split("T")[0];
      } else {
        nextPaymentPreview.textContent = "N/A";
      }
    };

    startMonthInput.addEventListener("change", calculateNextPayment);
    cycleInput.addEventListener("change", calculateNextPayment);
  }
});

</script>

{% endblock %}

