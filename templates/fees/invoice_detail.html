{% extends 'base.html' %}
{% block title %}{{ student.full_name }} - Invoices{% endblock %}
{% load widget_tweaks %}

{% block content %}
{% include "partials/_finance_header_tabs.html" %}

<div class="overflow-hidden text-sm bg-white shadow-sm rounded-2xl border border-gray-100 font-poppins">
    <table class="min-w-full">
        <!-- Header -->
        <thead class="bg-neutral-50">
            <tr>
                 <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 uppercase tracking-wide">
            <input type="checkbox" id="select-all" class="rounded-md border border-gray-300 focus:ring focus:ring-primary-500 focus:border-primary-500">
        </th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 uppercase tracking-wide">Date</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 uppercase tracking-wide">Status</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 uppercase tracking-wide">Amount Due</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 uppercase tracking-wide">Paid</th>
                <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 uppercase tracking-wide">Actions</th>

            </tr>
        </thead>

        <!-- Body -->
        <tbody class="divide-y divide-gray-100">
            {% for invoice in unpaid_invoices %}
            <tr class="hover:bg-neutral-50 transition">
                <td class="px-6 py-4 text-center">
                    <input type="checkbox" name="invoice_ids" value="{{ invoice.id }}" class="invoice-checkbox rounded-md border border-gray-300 px-3 py-2 focus:ring focus:ring-primary-500 focus:border-primary-500 text-sm" data-amount="{{ invoice.amount_due }}">
                </td>
                <td class="px-6 py-4 text-sm text-neutral-700">{{ invoice.due_date|date:"M d, Y" }}</td>
                <td class="px-6 py-4 text-sm font-medium">
                {% if invoice.get_status_display == 'Unpaid' %}
             <span class="px-2 py-1 rounded-lg text-xs font-semibold bg-red-100 text-red-700">Unpaid</span>
                {% elif invoice.get_status_display == 'OPENING_BALANCE' %}
             <span class="px-2 py-1 rounded-lg text-xs font-semibold bg-warning-100">Opening-Balance</span>
                {%endif %}
                
                </td>
                <td class="px-6 py-4 text-sm text-danger-600">{{ invoice.amount_due }} Br.</td>
                <td class="px-6 py-4 text-sm text-success-600">{{ invoice.amount_paid|default:0 }} Br.</td>
                 <td class="px-6 py-4 text-right flex justify-end gap-2">
          <a href="{% url 'fees:edit_invoice' invoice.id %}" 
             class="px-3 py-1.5 rounded-lg bg-gray-50 text-gray-600 hover:bg-gray-100">Edit</a>
          
          <a href="{% url 'fees:delete_invoice' invoice.id %}" 
             class="px-3 py-1.5 rounded-lg bg-red-50 text-red-600 hover:bg-red-100">Delete</a>
        </td>
                
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" class="px-6 py-6 text-center text-neutral-500 text-sm">
                    <i class="fas fa-info-circle mr-1"></i> No unpaid invoices for this student.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="p-4">
    
    <div class="mt-6 p-2 bg-neutral-100 rounded-xl mb-4 max-w-md">
        <p class="text-lg font-semibold text-neutral-800">
            Selected Total: <span id="selected-total">0.00</span>
        </p>
    </div>
    <!-- Payment History Section -->
   <div class="border border-neutral-200 rounded-xl overflow-hidden">
    <button type="button" class="collapsible w-full flex justify-between items-center px-4 py-3 bg-neutral-100 hover:bg-neutral-200">
        <span class="font-semibold text-neutral-800">
            <i class="fas fa-money-check-alt mr-2 text-primary-600"></i> Payment History
        </span>
        <i class="fas fa-chevron-down transition-transform duration-300"></i>
    </button>

    <div id="payment-history" class="collapsible-content  bg-neutral-50 p-6 space-y-4 hidden overflow-hidden transition-all duration-300 ease-in-out rounded-b-xl">
        <table class="min-w-full mt-2">
            <thead class="bg-neutral-100">
                <tr>
                   
                    <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 uppercase tracking-wide">Date</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 uppercase tracking-wide">Amount</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 uppercase tracking-wide">Method</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 uppercase tracking-wide">Reference</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {% for payment in payment_history %}
                <tr class="hover:bg-neutral-50 transition">
                    <td class="px-6 py-4 text-sm text-neutral-700">{{ payment.paid_on|date:"M d, Y" }}</td>
                    <td class="px-6 py-4 text-sm text-success-600">{{ payment.amount }} Br.</td>
                    <td class="px-6 py-4 text-sm text-neutral-700">{{ payment.method }}</td>
                    <td class="px-6 py-4 text-sm text-neutral-700">{{ payment.reference }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="px-6 py-6 text-center text-neutral-500 text-sm">
                        No payment history available.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>


    <!-- Payment Form -->
    <form method="post" action="" id="payment-form" class="mt-6 space-y-4">
        {% csrf_token %}

        <div>
            {{ form.method|add_class:"form-select text-sm rounded-md border border-gray-300 px-3 py-2 focus:ring focus:ring-primary-500 focus:border-primary-500" }}
        </div>

        <div>
            {{ form.reference|add_class:"form-input text-sm rounded-md border border-gray-300 px-3 py-2 focus:ring focus:ring-primary-500 focus:border-primary-500" }}
        </div>

        <div>
            {{ form.paid_on|add_class:"form-input text-sm rounded-md border border-gray-300 px-3 py-2 focus:ring focus:ring-primary-500 focus:border-primary-500" }}
        </div>

        <div>
                {{ form.receipt_type|add_class:"form-select text-sm rounded-md border border-gray-300 px-3 py-2 focus:ring focus:ring-primary-500 focus:border-primary-500" }}

        </div>
        <button type="submit" class="bg-primary-600 text-white px-6 py-2 rounded-md hover:bg-primary-700 transition text-sm font-semibold">
            Record Payment
        </button>
        </div>

        <!-- Hidden Fields -->
        {{ form.invoice_ids }}
        {{ form.payment_amount }}
    </form>
</div>


{% block scripts %}
<script>

  
    document.querySelectorAll('.collapsible').forEach(button => {
        button.addEventListener('click', () => {
            const content = button.nextElementSibling;
            const icon = button.querySelector('i.fas.fa-chevron-down');

            const isCollapsed = content.classList.contains('hidden');

            // Toggle height
            content.classList.toggle('hidden');
            content.classList.toggle('hidden');

            // Toggle icon rotation
            if (isCollapsed) {
                icon.classList.add('rotate-180');
            } else {
                icon.classList.remove('rotate-180');
            }
        });
    });
    // Function to update total based on selected invoices
    function updateTotal() {
        let totalAmount = 0;
        let selectedInvoices = [];

        // Loop through all checkboxes and add selected invoices
        document.querySelectorAll('.invoice-checkbox:checked').forEach(function (checkbox) {
            let amount = parseFloat(checkbox.getAttribute('data-amount'));
            totalAmount += amount;
            selectedInvoices.push(checkbox.value);
        });

        // Update the selected total
        document.getElementById('selected-total').textContent = `${totalAmount.toFixed(2)} Br.`;

        // Update the hidden fields
        document.getElementById('id_invoice_ids').value = selectedInvoices.join(',');
        document.getElementById('id_payment_amount').value = totalAmount.toFixed(2);
    }

    // Listen for changes in invoice checkboxes
    document.querySelectorAll('.invoice-checkbox').forEach(function (checkbox) {
        checkbox.addEventListener('change', updateTotal);
    });

    // Handle Select All checkbox
    document.getElementById('select-all').addEventListener('change', function () {
        let isChecked = this.checked;
        document.querySelectorAll('.invoice-checkbox').forEach(function (checkbox) {
            checkbox.checked = isChecked;
        });
        updateTotal();
    });

    // Initial call to set the total on page load
    updateTotal();
</script>
{% endblock %}
{% endblock %}