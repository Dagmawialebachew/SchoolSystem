{% extends 'base.html' %}
{% block title %}{{ student.full_name }} - Payments{% endblock %}
{% load humanize %}
{% block content %}
{% include "partials/_finance_header_tabs.html" %}

<div class="max-w-7xl mx-auto px-4">
{% if request.GET.receipt %}
  <div class="mb-4 rounded-xl border border-primary-200 bg-primary-50 p-4 flex items-center justify-between">
    <div class="text-sm text-primary-900">
      Receipts ready for download.
    </div>
    <div class="flex gap-2">
      {% if request.GET.rt == "single" %}
        <a href="{% url 'fees:fees_download_receipts' %}?mode=single&t={{ request.GET.receipt }}"
           class="px-3 py-2 rounded-lg bg-primary-600 text-white hover:bg-primary-700">
          Download PDF
        </a>
      {% else %}
        <a href="{% url 'fees:fees_download_receipts' %}?mode=separate&t={{ request.GET.receipt }}"
           class="px-3 py-2 rounded-lg bg-primary-600 text-white hover:bg-primary-700">
          Download ZIP
        </a>
      {% endif %}
    </div>
  </div>
{% endif %}

 
  <!-- ðŸ”¹ Summary Cards -->
  <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-8">
    <div class="bg-white border border-gray-100 p-4 rounded-2xl shadow-sm">
      <p class="text-sm text-gray-500">Total Paid</p>
      <h3 class="text-xl font-semibold text-green-600">{{ total_paid|default:"0"|intcomma }} Br</h3>
    </div>
    <div class="bg-white border border-gray-100 p-4 rounded-2xl shadow-sm">
      <p class="text-sm text-gray-500">Total Unpaid</p>
      <h3 class="text-xl font-semibold text-red-600">{{ total_unpaid|default:"0"|intcomma }} Br</h3>
    </div>
    <div class="bg-white border border-gray-100 p-4 rounded-2xl shadow-sm">
      <p class="text-sm text-gray-500">Payments Count</p>
      <h3 class="text-xl font-semibold text-blue-600">{{ payments|length }}</h3>
    </div>
    <div class="bg-white border border-gray-100 p-4 rounded-2xl shadow-sm">
      <p class="text-sm text-gray-500">Last Payment</p>
      <h3 class="text-lg font-semibold text-gray-800">
        {% if last_payment %}
          {{ last_payment|date:"F j, Y" }}
        {% else %}
          â€”
        {% endif %}
      </h3>
    </div>
  </div>

  <!-- ðŸ”¹ Filters -->
  <form method="get" class="mb-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
    <input 
      type="text" 
      name="search" 
      placeholder="Search by reference..."
      value="{{ request.GET.search }}"
      class="border border-gray-300 rounded-xl px-3 py-2 focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
    />

    <select 
      name="method"
      class="border border-gray-300 rounded-xl px-3 py-2 focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
    >
      <option value="">All Methods</option>
      {% for method in payment_methods %}
      <option value="{{ method }}" {% if request.GET.method == method %}selected{% endif %}>{{ method }}</option>
      {% endfor %}
    </select>

    <select 
      name="fee_type"
      class="border border-gray-300 rounded-xl px-3 py-2 focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
    >
      <option value="">All Fee Types</option>
      {% for fee in fee_types %}
      <option value="{{ fee.id }}" {% if request.GET.fee_type == fee.id|stringformat:"s" %}selected{% endif %}>{{ fee.name }}</option>
      {% endfor %}
    </select>

    <input 
      type="date" 
      name="start_date" 
      value="{{ request.GET.start_date }}"
      class="border border-gray-300 rounded-xl px-3 py-2 focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
    />

    <input 
      type="date" 
      name="end_date" 
      value="{{ request.GET.end_date }}"
      class="border border-gray-300 rounded-xl px-3 py-2 focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
    />

    <button type="submit"
      class="col-span-1 sm:col-span-2 lg:col-span-5 bg-primary-600 text-white px-4 py-2 rounded-xl hover:bg-primary-700 transition">
      Apply Filters
    </button>
  </form>

  <!-- ðŸ”¹ Payment Table -->
  <form id="export-form" method="get" action="{% url 'fees:export_payments' student.pk %}">
  <div class="overflow-hidden bg-white shadow-sm rounded-2xl border border-gray-100">
  <div class="flex justify-between items-center px-6 py-4 border-b">
    <h2 class="text-lg font-semibold text-gray-800">Payments</h2>
    <div class="relative">
      <button type="button" 
        class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-primary-600 text-white hover:bg-primary-700 focus:outline-none" id="menu-button">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
        Export
      </button>
     <div class="absolute right-0 mt-2 w-48 z-50 bg-white border border-gray-100 rounded-xl shadow-lg hidden group-hover:block" id="export-menu">
  <button type="submit" name="export_type" value="pdf" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-50">Export Selected as PDF</button>
  <button type="submit" name="export_type" value="excel" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-50">Export Selected as Excel</button>
  <button type="submit" name="export_type" value="pdf_all" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-50">Export All as PDF</button>
  <button type="submit" name="export_type" value="excel_all" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-50">Export All as Excel</button>
</div>
    </div>
  </div>

  <table class="min-w-full">
    <thead class="bg-neutral-50 sticky top-0 z-10">
      <tr>
        <th class="px-6 py-3">
          <input type="checkbox" id="select-all" class="h-4 w-4 rounded border-gray-300">
        </th>
        <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 uppercase">Date</th>
        <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 uppercase">Fee Type</th>
        <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 uppercase">Amount</th>
        <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 uppercase">Method</th>
        <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 uppercase">Reference</th>
        <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 uppercase">Actions</th>      
      </tr>
    </thead>
    <tbody class="divide-y divide-gray-100">
      {% for payment in payments %}
      <tr class="hover:bg-neutral-50 transition">
        <td class="px-6 py-4">
          <input type="checkbox"  name="payments" 
  value="{{ payment.id }}"  class="select-payment h-4 w-4 rounded border-gray-300">
        </td>
        <td class="px-6 py-4 text-sm">
          {% if payment.paid_on|date:"Y-m-d" == today %}
            <span class="bg-green-100 text-green-700 px-2 py-1 rounded-lg text-xs">New</span>
          {% endif %}
          {{ payment.paid_on|date:"F j, Y" }}
        </td>
        <td class="px-6 py-4 text-sm">{{ payment.invoice.fee.name }}</td>
        <td class="px-6 py-4 text-sm font-medium text-green-600">{{ payment.amount|intcomma }} Br</td>
        <td class="px-6 py-4 text-sm">{{ payment.method }}</td>
        <td class="px-6 py-4 text-sm">{{ payment.reference|default:"â€”" }}</td>
        <td class="px-2 py-4 flex gap-2">
          <a href="{% url 'fees:invoice_detail' student.pk %}" 
             class="text-primary-600 rounded-lg px-3 py-1.5 bg-primary-50 hover:bg-primary-100">
            View
          </a>
          <a href="{% url 'fees:reverse_payment' payment.id %}" 
             class="px-3 py-1.5 rounded-lg bg-red-50 text-red-600 hover:bg-red-100">
            Reverse
          </a>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="7" class="px-6 py-6 text-center text-neutral-500 text-sm">
          No payments recorded for this student.
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

  <div class="mt-6 flex justify-center">
    {% if is_paginated %}
        <nav class="flex space-x-2">
            {% if payments.has_previous %}
                <a href="?page=1" class="px-3 py-1 border rounded-lg text-sm">First</a>
                <a href="?page={{ payments.previous_page_number }}" class="px-3 py-1 border rounded-lg text-sm">Previous</a>
            {% endif %}

            <span class="px-3 py-1 border rounded-lg text-sm bg-primary-100 text-primary-700">
                Page {{ payments.number }} of {{ payments.paginator.num_pages }}
            </span>

            {% if payments.has_next %}
                <a href="?page={{ payments.next_page_number }}" class="px-3 py-1 border rounded-lg text-sm">Next</a>
                <a href="?page={{ payments.paginator.num_pages }}" class="px-3 py-1 border rounded-lg text-sm">Last</a>
            {% endif %}
        </nav>
    {% endif %}
</div>
</form>
<!--Reverse Payment-->

<div class="mt-10 overflow-hidden bg-white shadow-sm rounded-2xl border border-gray-100">
  <h2 class="text-lg font-semibold text-gray-800 px-6 py-4 border-b">Reversal History</h2>
  <div class="overflow-hidden bg-white shadow-sm rounded-2xl border border-gray-100">
    <table class="min-w-full">
      <thead class="bg-neutral-50">
        <tr>
         
          <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 uppercase">#</th>
          <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 uppercase">Date</th>
          <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 uppercase">Fee Type</th>
          <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 uppercase">Amount</th>
          <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 uppercase">Method</th>
          <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 uppercase">Reference</th>
          <th class="px-6 py-3 text-left text-xs font-semibold text-neutral-500 uppercase">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100">
        {% for payment in payments %}
        <tr>
         
          <td class="px-6 py-4">{{ forloop.counter }}</td>
          <td class="px-6 py-4">{{ payment.paid_on|date:"F j, Y" }}</td>
          <td class="px-6 py-4">{{ payment.invoice.fee.name }}</td>
          <td class="px-6 py-4">{{ payment.amount|intcomma }} Br</td>
          <td class="px-6 py-4">{{ payment.method }}</td>
          <td class="px-6 py-4">{{ payment.reference|default:"â€”" }}</td>
          <td class="px-6 py-4">
            <a href="{% url 'fees:invoice_detail' student.pk %}" class="text-primary-600">View Invoice</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>



</div>

{% block scripts %}
<script>
  document.getElementById('menu-button').addEventListener('click', function() {
    document.getElementById('export-menu').classList.toggle('hidden');
  });
  
  document.getElementById('select-all').addEventListener('change', function(e) {
    const checkboxes = document.querySelectorAll('input[name="payments"]');
    checkboxes.forEach(cb => cb.checked = e.target.checked);
  });
</script>
{% endblock %}
{% endblock %}