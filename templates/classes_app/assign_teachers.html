{% extends 'base.html' %}
{% load static %}

{% block title %}Assign Teachers – {{ class_program.name }}{% endblock %}

{% block content %}
<!-- Header -->
<div class="flex items-center justify-between mb-8">
  <div class="flex items-center gap-3">
    <div class="h-12 w-12 flex items-center justify-center rounded-xl bg-primary-50 text-primary-600 shadow-sm">
      <i class="fas fa-user-check text-xl"></i>
    </div>
    <div>
      <h1 class="text-2xl font-bold text-neutral-900">Assign teachers</h1>
      <p class="text-sm text-neutral-600">
        Class: <strong>{{ class_program.name }}</strong> • Division: {{ class_program.division.get_name_display }}
      </p>
    </div>
  </div>
  <a href="{% url 'classes_app:detail' class_program.pk %}"
     class="px-4 py-2 rounded-lg border border-neutral-200 bg-white hover:bg-neutral-50 text-sm font-medium flex items-center gap-2 shadow-sm">
    <i class="fas fa-arrow-left"></i> Back to class
  </a>
</div>

<form method="post" id="assignForm" class="space-y-6">
  {% csrf_token %}

  <!-- Toolbar -->
  <div class="bg-white border border-neutral-200 rounded-2xl shadow-sm p-4 flex flex-wrap items-center gap-3">
    <input id="teacherSearch" type="text" placeholder="Search teachers…"
           class="w-64 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm">
    <button type="button" id="selectAllBtn"
            class="px-3 py-1.5 rounded-full bg-neutral-100 text-neutral-700 hover:bg-neutral-200 text-xs font-medium">Select all</button>
    <button type="button" id="clearAllBtn"
            class="px-3 py-1.5 rounded-full bg-neutral-100 text-neutral-700 hover:bg-neutral-200 text-xs font-medium">Clear all</button>
    <span class="text-sm text-neutral-600" id="selectedCount">Selected: 0</span>
    <div class="ml-auto">
      <button type="submit"
              class="px-5 py-2 rounded-lg bg-primary-600 text-white hover:bg-primary-700 text-sm font-semibold shadow-sm">
        Save assignments
      </button>
    </div>
  </div>

  <!-- Teacher grid -->
  <div class="bg-white border border-neutral-200 rounded-2xl shadow-sm p-4">
    <div id="teacherGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      {% for t in teachers %}
      <label class="teacher-card rounded-xl border border-neutral-200 p-4 hover:shadow-md transition cursor-pointer flex flex-col justify-between"
             data-name="{{ t.full_name|lower }}"
             data-selected="{% if t.pk in selected_ids %}true{% else %}false{% endif %}">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="flex items-center gap-2">
              <input type="checkbox" name="teachers" value="{{ t.pk }}"
                     class="teacher-checkbox h-4 w-4 text-primary-600 rounded border-gray-300"
                     {% if t.pk in selected_ids %}checked{% endif %}>
              <span class="font-semibold text-neutral-900">{{ t.full_name }}</span>
            </div>
            {% if t.email or t.phone %}
            <p class="mt-1 text-xs text-neutral-600">
              {% if t.email %}<i class="fas fa-envelope mr-1"></i>{{ t.email }}{% endif %}
              {% if t.phone %}<span class="ml-2"><i class="fas fa-phone mr-1"></i>{{ t.phone }}</span>{% endif %}
            </p>
            {% endif %}
          </div>
          <label class="inline-flex items-center gap-2 text-xs">
            <input type="checkbox" name="homeroom_teachers" value="{{ t.pk }}"
                   class="homeroom-checkbox h-3 w-3 text-blue-600 rounded border-gray-300"
                   {% if t.pk in homeroom_ids %}checked{% endif %}
                   {% if t.pk not in selected_ids %}disabled{% endif %}>
            <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-blue-100 text-blue-800">
              <i class="fas fa-chalkboard-teacher mr-1 text-[10px]"></i> Homeroom
            </span>
          </label>
        </div>
      </label>
      {% empty %}
      <div class="rounded-lg border border-neutral-200 p-4 text-center text-neutral-600">
        <i class="fas fa-info-circle mr-1"></i>No teachers found in this school.
      </div>
      {% endfor %}
    </div>
  </div>
</form>

<!-- Notes -->
<div class="bg-white border border-neutral-200 rounded-2xl shadow-sm p-4">
  <h2 class="text-sm font-semibold text-neutral-900 mb-2">Notes</h2>
  <ul class="list-disc pl-5 space-y-1 text-sm text-neutral-600">
    <li>Selected teachers are pinned at the top of the list.</li>
    <li>Homeroom toggle is enabled only for selected teachers.</li>
    <li>Subject‑level assignments are managed on the class subjects page.</li>
  </ul>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.getElementById("teacherSearch");
    const grid = document.getElementById("teacherGrid");
    const selectAllBtn = document.getElementById("selectAllBtn");
    const clearAllBtn = document.getElementById("clearAllBtn");
    const selectedCount = document.getElementById("selectedCount");
    const teacherCheckboxes = Array.from(document.querySelectorAll(".teacher-checkbox"));
    const homeroomCheckboxes = Array.from(document.querySelectorAll(".homeroom-checkbox"));

    function updateHomeroomStates() {
      homeroomCheckboxes.forEach(hr => {
        const teacherId = hr.value;
        const teacherChecked = document.querySelector(`.teacher-checkbox[value="${teacherId}"]`).checked;
        hr.disabled = !teacherChecked;
        if (!teacherChecked) hr.checked = false;
      });
    }

    function updateSelectedCount() {
      const count = teacherCheckboxes.filter(cb => cb.checked).length;
      selectedCount.textContent = `Selected: ${count}`;
    }

    function filterCards() {
      const q = (searchInput.value || "").toLowerCase();
      Array.from(grid.children).forEach(card => {
        const name = (card.getAttribute("data-name") || "").toLowerCase();
        card.style.display = (!q || name.includes(q)) ? "" : "none";
      });
    }

    function reorderCards() {
      const cards = Array.from(grid.children);
      const selected = cards.filter(c => c.querySelector(".teacher-checkbox").checked);
      const unselected = cards.filter(c => !c.querySelector(".teacher-checkbox").checked);
      grid.innerHTML = "";
      selected.forEach(c => grid.appendChild(c));
      unselected.forEach(c => grid.appendChild(c));
    }

    teacherCheckboxes.forEach(cb => {
      cb.addEventListener("change", () => {
        updateHomeroomStates();
        updateSelectedCount();
        reorderCards();
      });
    });

    selectAllBtn.addEventListener("click", () => {
      teacherCheckboxes.forEach(cb => cb.checked = true);
      updateHomeroomStates();
      updateSelectedCount();
      reorderCards();
    });

    clearAllBtn.addEventListener("click", () => {
      teacherCheckboxes.forEach(cb => cb.checked = false);
      homeroomCheckboxes.forEach(cb => { cb.checked = false; cb.disabled = true; });
      updateSelectedCount();
      reorderCards();
    });

    searchInput.addEventListener("input", filterCards);

    // init
    updateHomeroomStates();
    updateSelectedCount();
    reorderCards();
  });
</script>
{% endblock %}
