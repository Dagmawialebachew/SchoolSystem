{% extends 'base.html' %}
{% load static %}
{% block title %}My Profile — SchoolSystem{% endblock %}

{% block content %}
<!-- Use a larger, more modern container and primary color variables -->
<div class="max-w-5xl mx-auto px-4 py-8 sm:px-6 sm:py-12 space-y-10">

    <!-- PROFILE HEADER & AVATAR -->
    <section class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-6 pb-4 border-b border-gray-200">
    
        <!-- Left section: avatar and text -->
        <div class="flex flex-col sm:flex-row items-center sm:items-start gap-6">
            
            <!-- Avatar container fixed height, never stretches -->
            <div class="flex-shrink-0">
                <div class="w-24 h-24 rounded-full overflow-hidden shadow-lg ring-4 ring-primary-500/30 flex items-center justify-center bg-gray-100">
                    {% if parent_profile.avatar %}
                        <img src="{{ parent_profile.avatar.url }}" 
                                alt="Avatar of {{ user.get_full_name }}" 
                                class="w-full h-full object-cover">
                    {% else %}
                        <i class="fas fa-user text-4xl text-primary-600"></i>
                    {% endif %}
                </div>
            </div>

            <!-- Text section -->
            <div class="text-center sm:text-left">
                <h1 class="text-3xl sm:text-4xl font-black text-neutral-900 leading-tight">{{ user.get_full_name }}</h1>
                <p class="text-sm font-semibold text-primary-600 mb-1">Parent Account</p>
                <p class="text-sm text-neutral-600">{{ user.email }}</p>
                <p class="text-xs text-neutral-400 mt-1">Last seen: {{ user.last_login|date:"M d, Y @ H:i" }}</p>
            </div>

        </div>

        <!-- Right: Update button -->
        <a href="{% url 'parents:edit_profile' %}" 
            class="self-center sm:self-auto px-5 py-2.5 bg-primary-600 text-white text-base font-semibold rounded-xl shadow-lg shadow-primary-500/30 hover:bg-primary-700 transition duration-300 transform hover:scale-[1.02] whitespace-nowrap">
            <i class="fas fa-user-edit mr-2"></i> Update Profile Info
        </a>
    </section>


    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- CONTACT INFO & TELEGRAM (COL-1) -->
        <section class="bg-white rounded-2xl shadow-xl border border-gray-100 p-6 space-y-5 lg:col-span-1 h-fit">
            <h2 class="text-xl font-bold text-neutral-900 flex items-center gap-3 mb-4 border-b pb-3">
                <i class="fas fa-phone-alt text-primary-600"></i> Communication Settings
            </h2>
            
            <dl class="space-y-4 text-sm">
                <!-- Phone Number -->
                <div>
                    <dt class="text-neutral-500 font-medium flex items-center gap-2">
                        <i class="fas fa-mobile-alt"></i> Primary Phone
                    </dt>
                    <dd class="font-semibold text-neutral-800 text-base">{{ parent_profile.phone_number|default:"— Not Set —" }}</dd>
                </div>

                <!-- Telegram Connection Status -->
                <div>
                    <dt class="text-neutral-500 font-medium flex items-center gap-2">
                        <i class="fab fa-telegram-plane"></i> Telegram Notifications
                    </dt>
                    <dd class="font-medium flex items-center justify-between mt-1">
                        {% if parent_profile.telegram_chat_id %}
                            <span class="text-emerald-600 font-bold flex items-center gap-1">
                                <i class="fas fa-check-circle"></i> Connected
                            </span>
                            <a href="{% url 'parents:disconnect_telegram' %}" 
                                class="px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 text-xs transition">
                                Disconnect
                            </a>
                        {% else %}
                            <span class="text-red-500 font-semibold flex items-center gap-1">
                                <i class="fas fa-times-circle"></i> Not Connected
                            </span>
                           <!-- Connect to Telegram button - Uses context variables -->
                            <div class="relative flex items-center gap-2">
                                <button id="connect-telegram-btn"
                                        type="button"
                                        class="px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-xs font-semibold transition flex items-center"
                                        data-bot="{{ bot_username }}" 
                                        data-param="{{ start_param }}"
                                        aria-live="polite">
                                    <i class="fab fa-telegram-plane mr-1"></i>
                                    Connect Now
                                </button>

                                <!-- hidden fallback link (https) for copy / manual open -->
                                <a id="telegram-https-link" 
                                    href="https://t.me/{{ bot_username }}?start={{ start_param }}"
                                    class="sr-only" 
                                    target="_blank" 
                                    rel="noopener noreferrer">Open Telegram</a>
                            </div>

                            <!-- small unobtrusive helper text shown on failure -->
                            


                        {% endif %}
                    </dd>
                    <div id="tg-helper" class="mt-2 block text-xs text-neutral-500 hidden">
                                <span>If Telegram didn't open, </span>
                                <button id="copy-tg-link" type="button" class="underline text-primary-600 hover:text-primary-700">copy link</button>
                                <span> and paste it into Telegram.</span>
                            </div>
                </div>
            </dl>
        </section>

        <!-- LINKED CHILDREN & NOTIFICATIONS (COL-2/3) -->
        <div class="lg:col-span-2 space-y-8">

            <!-- LINKED CHILDREN -->
            <section class="bg-white rounded-2xl shadow-xl border border-gray-100 p-6">
                <h2 class="text-xl font-bold text-neutral-900 mb-6 flex items-center gap-3 border-b pb-3">
                    <i class="fas fa-user-friends text-primary-600"></i> My Linked Students
                </h2>
                {% if children %}
                    <ul class="divide-y divide-gray-100">
                        {% for child in children %}
                            <!-- Added dedicated link to view child profile -->
                            <a href="{% url 'parents:child_detail' child.pk %}" class="block"> 
                                <li class="py-3 flex justify-between items-center hover:bg-primary-50 px-3 rounded-xl transition duration-150">
                                    <div class="flex items-center gap-4">
                                        <!-- Child Initials/Avatar Placeholder -->
                                        <div class="w-10 h-10 rounded-full bg-primary-100 flex items-center justify-center text-primary-700 font-bold text-lg">
                                            {{ child.full_name|slice:":1" }}
                                        </div>
                                        <div>
                                            <p class="font-bold text-neutral-800">{{ child.full_name }}</p>
                                            <p class="text-sm text-neutral-500">{{ child.class_program.name }}</p>
                                        </div>
                                    </div>
                                    <i class="fas fa-arrow-right text-primary-500 hover:translate-x-1 transition"></i>
                                </li>
                            </a>
                        {% endfor %}
                    </ul>
                {% else %}
                    <!-- Clear call to action for linking children -->
                    <div class="text-center p-8 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                        <i class="fas fa-exclamation-circle text-2xl text-yellow-500 mb-2"></i>
                        <p class="text-base text-neutral-600 font-medium">No students are currently linked to your account.</p>
                        <p class="text-sm text-neutral-500 mt-1">Please contact the school administration to link your child's profile.</p>
                    </div>
                {% endif %}
            </section>

            <!-- NOTIFICATIONS -->
            <section class="bg-white rounded-2xl shadow-xl border border-gray-100 p-6">
                <h2 class="text-xl font-bold text-neutral-900 mb-4 flex items-center gap-3 border-b pb-3">
                    <i class="fas fa-inbox text-primary-600"></i> Recent Notifications
                </h2>
                {% if parent_profile.notifications.all %}
                    <ul class="divide-y divide-gray-100 text-sm">
                        {% for note in parent_profile.notifications.all|slice:":5" %} <!-- Show more notifications -->
                            <li class="py-3 flex justify-between items-start hover:bg-gray-50 px-2 rounded-lg transition">
                                <span class="text-neutral-700 flex-1 pr-4">{{ note.message }}</span>
                                <span class="text-xs text-neutral-400 whitespace-nowrap pt-0.5" title="{{ note.created_at }}">
                                    {{ note.created_at|date:"M d" }}
                                </span>
                            </li>
                        {% endfor %}
                        <li class="pt-4 text-center">
                            <a href="{% url 'parents:all_notifications' %}" class="text-sm text-primary-600 font-medium hover:text-primary-700 transition">
                                View All Notifications <i class="fas fa-arrow-right ml-1"></i>
                            </a>
                        </li>
                    </ul>
                {% else %}
                    <p class="text-sm text-neutral-500">You have no recent notifications.</p>
                {% endif %}
            </section>
        </div>
    </div>
</div>

<script>
(function() {
    const btn = document.getElementById('connect-telegram-btn');
    const helper = document.getElementById('tg-helper');
    const httpsLink = document.getElementById('telegram-https-link');
    const copyBtn = document.getElementById('copy-tg-link');

    if (!btn || !copyBtn) return;

    btn.addEventListener('click', (e) => {
        e.preventDefault();
        
        const bot = btn.dataset.bot?.replace(/^@/, '') || 'YourSchoolBot';
        const param = btn.dataset.param || 'test_start';
        
        // Telegram Deep Link URL (tg://)
        const tgScheme = `tg://resolve?domain=${bot}&start=${encodeURIComponent(param)}`;
        
        // HTTPS fallback URL (opens in a new tab)
        const httpsUrl = `https://t.me/${bot}?start=${encodeURIComponent(param)}`;

        // Try to open Telegram app
        window.location.href = tgScheme;

        // Fallback after 1 second → open in new tab instead of current
        setTimeout(() => {
            if (document.visibilityState === 'visible') {
                window.open(httpsUrl, '_blank', 'noopener,noreferrer');
            }
        }, 1000); 

        // Show helper text after 3 seconds
        setTimeout(() => {
            helper.classList.remove('hidden');
        }, 3000);
    });

    // Copy Link
    copyBtn.addEventListener('click', () => {
        const httpsUrl = httpsLink.href;
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(httpsUrl).then(() => {
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'Copied!';
                copyBtn.classList.remove('text-primary-600');
                copyBtn.classList.add('text-emerald-600'); 
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.classList.remove('text-emerald-600');
                    copyBtn.classList.add('text-primary-600'); 
                }, 1500);
            }).catch(() => {
                window.prompt("Copy this link manually:", httpsUrl);
            });
        } else {
            window.prompt("Copy this link manually:", httpsUrl);
        }
    });

})();
</script>

{% endblock %}
